Задача: Изучить механику Telegram Gift Auctions и реализовать аналогичную систему аукциона цифровых товаров. Подробное техническое задание не предоставляется – самостоятельный анализ продукта является частью конкурса.

Стек: Node.js, TypeScript, MongoDB.

Что нужно сделать: Реализовать backend-логику аукциона (раунды, ставки, ранжирование, anti-sniping, работа с балансом), минимальный UI для демонстрации и проверку работы под нагрузкой.


## 1. Архитектура системы (Clean Architecture)
Проект должен быть разделен на слои, чтобы бизнес-логика не зависела от БД или фреймворка:
- **Domain Layer**: интерфейсы сущностей (`Auction`, `Bid`, `User`) и чистые функции (расчет анти-снайпинга, логика ранжирования).
- **Application Layer (Use Cases)**: сценарии (`PlaceBid`, `FinishRound`, `WithdrawFunds`). Здесь управляются транзакции.
- **Infrastructure Layer**: реализация репозиториев (MongoDB), кэширование (Redis), планировщик задач (BullMQ).
- **Presentation Layer**: REST API (Express/Fastify) и WebSockets (Socket.io).

***

## 2. Модель данных и работа с балансом
Для обеспечения финансовой безопасности мы отказываемся от простого поля `balance`. Используется **система двойной записи (Ledger)** или **Hold/Release**.

### Сущности в MongoDB:
- **User**: `id`, `username`, `walletAddress`.
- **Wallet**: `userId`, `availableBalance`, `lockedBalance` (сумма в активных ставках).
- **Auction**: `id`, `title`, `totalItems` (сколько подарков разыгрывается), `status` (active/processing/finished).
- **Round**: `auctionId`, `roundNumber`, `startTime`, `endTime`.
- **Bid**: `userId`, `auctionId`, `amount`, `timestamp`, `status` (winning/outbid/refunded).

### Транзакционная логика ставки:
1. Открытие транзакции MongoDB (`session.startTransaction()`).[1]
2. Проверка: `availableBalance >= amount`.
3. Списание: `availableBalance -= amount`, `lockedBalance += amount`.
4. Создание записи `Bid` с меткой времени.
5. Фиксация транзакции. При любой ошибке происходит `abortTransaction`.

***

## 3. Механика аукциона и Anti-sniping
Основная сложность — корректная обработка последних секунд раунда.

### Логика Anti-sniping:
Если ставка сделана в интервале `threshold` (например, за 60 секунд до `endTime` раунда), `endTime` сдвигается вперед на `extension_time` (например, +2 минуты).[2][3]
- **Реализация**: При сохранении ставки проверяется условие `endTime - now < 60s`. Если истинно — обновляется документ раунда и отправляется событие в WebSocket.

### Ранжирование и раунды:
В Telegram Gift Auctions в одном раунде может быть несколько победителей (например, 100 копий подарка).
- **Алгоритм ранжирования**: 
    1. Сортировка по `amount` DESC (от большей суммы к меньшей).
    2. При равных суммах — сортировка по `timestamp` ASC (кто первый поставил, тот выше).
- **Переход раундов**: По истечении времени топ-N участников фиксируются как победители. Остальные ставки **не возвращаются**, а остаются «залоченными» и переходят в следующий раунд, пока пользователь не решит их отозвать или не выиграет.[4][5]

***

## 4. Обработка высокой нагрузки (High Load)
В момент окончания аукциона ожидается всплеск запросов.

- **Distributed Locking (Redlock)**: Чтобы избежать гонки данных при обновлении `endTime`, используйте Redis-блокировки на уровне `auctionId`.
- **Event-Driven Round Closing**: Вместо `setInterval`, используйте **BullMQ**. При создании раунда планируется задача `close-round` на время `endTime`. Если время продлевается через Anti-sniping, задача в BullMQ перезаписывается.
- **Read-Optimized Leaderboard**: Текущий топ-100 ставок должен храниться в **Redis Sorted Set (ZSET)**. Это позволяет получать лидерборд за \(O(1)\) или \(O(\log N)\), не нагружая MongoDB агрегациями.

***

## 5. Minimal UI (Frontend)
Интерфейс должен демонстрировать работу всех механик в реальном времени.

### Технологический стек:
React + Tailwind + Socket.io-client.

### Функционал:
1. **Live Auction Card**:
    - Динамический таймер (синхронизирован с сервером).
    - Список Top Bids, обновляющийся «на лету» через сокеты.
    - Анимация продления времени (Anti-sniping).
2. **Bidding Interface**:
    - Поле ввода ставки с валидацией (минимум +5% к текущей или минимальный шаг).
    - Индикатор состояния: «Вы выигрываете» (зеленый) / «Ваша ставка перебита» (красный).
3. **Admin Panel**: Кнопка для ручного запуска/сброса аукциона для целей тестирования.

***

## 6. План тестирования и демонстрации
Для победы в конкурсе необходимо доказать надежность системы:
- **Unit Tests**: Проверка функции ранжирования (кейсы с одинаковыми ставками).
- **Integration Tests**: Симуляция процесса ставки от начала до конца с проверкой баланса.
- **Load Test (K6)**: Сценарий на 1000 RPS, где 90% запросов — чтение лидерборда, 10% — агрессивные ставки в последние 5 секунд.

